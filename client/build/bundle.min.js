const MAX_NUM=50,GRAVITY=-4e-4,VELOCITYX=.005,VELOCITYY=.025,MAX_AVAILABLE=5,TIMEOUT=2e3,supportsTouch=window&&"ontouchstart"in window,clickEvent=supportsTouch?"touchend":"mouseup";let audioReady=!1;const settings$1={mutedAudio:!1};await Tone.loaded();const audio=new Tone.Sampler({urls:{C1:"firework_b.mp3"},baseUrl:"assets/sounds/",onload:()=>{audioReady=!0}}).toDestination();window.addEventListener("keyup",initAudio),window.addEventListener(clickEvent,initAudio);async function initAudio(){Tone.context.resume(),window.removeEventListener("keyup",initAudio),window.removeEventListener(clickEvent,initAudio)}const freqs=["C1","G1","C2","G2"];function playAudio(){if(settings$1.mutedAudio)return;const e=pInst.random(freqs);audio.triggerAttackRelease(e,.875)}class Rocket{static getRandomPosition(){return[pInst.random(-.25,.25),-.5]}static getRandomVelocity(){return[pInst.random(-1,1)*.005,pInst.random(.9,1.1)*.025]}static getRandomAirtime(o){let t=0;for(;o>pInst.random(-.05,.01);)o+=-4e-4,t++;return Math.floor(t*100/6)}static getRandomExplosiontime(){return 1e3+Math.floor(pInst.random(-250,250))}constructor(){this.seed=0,this.hue=0,this.start=0,this.delta=0,this.explosion=0,this.lifetime=0,this.airtime=0,this.explosiontime=0,this.launched=!1,this.exploded=!1,this.sound=!1,this.pos=new p5.Vector,this.vel=new p5.Vector}launch(o,t){this.start=o,this.launched=!0,this.pos.set(t.position),this.vel.set(t.velocity);for(const s of["seed","hue","airtime","explosiontime","lifetime"])this[s]=t[s]}update(o){if(!this.launched)return;let t=o-this.start;this.delta=t/this.lifetime,this.exploded=t/this.airtime>=1,this.exploded?(this.vel.y+=-4e-4*.5,this.vel.x*=.95,this.vel.y*=.95,this.explosion=(t-this.airtime)/this.explosiontime):this.vel.y+=-4e-4,this.pos.add(this.vel),this.exploded&&!this.played&&(this.played=!0,playAudio()),!(this.delta<1)&&(this.launched=!1,this.exploded=!1,this.played=!1,this.lifetime=0,this.airtime=0,this.explosiontime=0,this.delta=0,this.explosion=0,this.vel.set(0,0),this.pos.set(0,0))}}const rockets=Array.from({length:50},()=>new Rocket),rocketsAvailableWrap=document.getElementById("rockets-available-wrap");let rocketsAvailable=5;const rocketIconKeyframes=[{opacity:.125},{opacity:.625}],rocketIconOptions={duration:2e3,fill:"none",easing:"ease-in-out",iterations:1};function createRocketIcons(){rocketsAvailableWrap.textContent="";for(let e=0;e<5;e+=1){const o=document.createElement("span");o.innerHTML="&#128640;",rocketsAvailableWrap.appendChild(o)}}function getRocketValues(){if(rocketsAvailable<=0)return null;const e=settings.useCustomColor?settings.customColorHue:Math.floor(Math.random()*360),o=Rocket.getRandomPosition(),t=Rocket.getRandomVelocity(),s=Rocket.getRandomAirtime(t[1]),n=Rocket.getRandomExplosiontime();return{seed:Math.random(),hue:e,position:o,velocity:t,airtime:s,explosiontime:n,lifetime:s+n}}function launchRocket(e){const o=rockets.find(s=>!s.launched);if(o===void 0)return;const t=[...rocketsAvailableWrap.children].find(s=>!s.classList.contains("launched"));t.classList.add("launched"),t.animate(rocketIconKeyframes,rocketIconOptions),rocketsAvailable-=1,o.launch(pInst.millis(),e),setTimeout(()=>{t.classList.remove("launched"),rocketsAvailable+=1},2e3)}const countdownWrap=document.getElementById("countdown-wrap"),dateNewYear=new Date;let timestamp,timestampUpdated=Date.now(),timeNewYear;setNewYearDate();let deltaTime,deltas=[];const thresholds=[1e3*60*60*24,1e3*60*60,1e3*60,1e3];function updateTimer(){if(timestamp=Date.now(),toSeconds(timestamp)===toSeconds(timestampUpdated))return;timestampUpdated=Date.now(),deltaTime=timeNewYear-timestamp;const[e,o,t,s]=time2dhms(deltaTime);deltaTime>=thresholds[0]&&e===deltas[0]||deltaTime>=thresholds[1]&&o===deltas[1]&&t===deltas[2]||(deltas=[e,o,t,s],countdownWrap.innerHTML=s>10?`<div>${dhms2string(...deltas)}<br>left until ${dateNewYear.getFullYear()}</div>`:s>3?`<span class='less-than-ten'>${s}</span>`:s>0?`<span class='less-than-three'>${s}</span>`:`Happy New Year!<br>${dateNewYear.getFullYear()}`,s<-86400&&setNewYearDate())}function setNewYearDate(){dateNewYear.setFullYear(dateNewYear.getFullYear()+1,0,1),dateNewYear.setHours(0,0,0,0),timeNewYear=dateNewYear.getTime()}function toSeconds(e){return Math.floor(e/1e3)}function time2dhms(e){return thresholds.map(o=>Math.floor(e/o))}function dhms2string(e,o,t,s){return e>0?`${e} day${pluralString(e)}`:o>0?`${digitString(o)} hour${pluralString(o)}<br>${digitString(t%60)} minute${pluralString(t)}`:t>0?`${digitString(t)} minute${pluralString(t)}<br>${digitString(s%60)} second${pluralString(s)}`:s>10?`${digitString(s)} second${pluralString(s)}`:`${s}`}function digitString(e){return`<span class="digits">${e}</span>`}function pluralString(e){return e>1?"s":""}let loadedShader=!1,loadingError=!1,fancyShader,fancyGraphics,radius=0,count=0,seeds=[],colors=[],positions=[],velocities=[],explosions=[];const settings={useCustomColor:!1,customColorHue:0,useFancyGraphics:!0};let pInstReady=!1;const pInst=new p5(sketch,document.getElementById("canvas-wrap"));function sketch(e){e.preload=()=>{fancyShader=e.loadShader("assets/glsl/basic.vert","assets/glsl/basic.frag",()=>loadedShader=!0,()=>loadingError=!0)},e.setup=()=>{e.createCanvas(e.windowWidth,e.windowHeight),e.pixelDensity(1),e.colorMode(e.HSL,359,1,1,1),fancyGraphics=e.createGraphics(e.width,e.height,e.WEBGL),fancyGraphics.pixelDensity(1),setMeasurements(e)},e.draw=()=>{if(loadingError){e.noStroke(),e.fill(0,0,1),e.clear(),e.push(),e.text("An error occured loading the assets! Please refresh the page.",.5*e.width,.5*e.height),e.pop(),e.noLoop();return}if(loadedShader&&audioReady&&!pInstReady&&(createRocketIcons(),pInstReady=!0),!pInstReady)return;updateTimer();const o=e.millis();for(const t of rockets)t.update(o);if(settings.useFancyGraphics){serialize(),fancyShader.setUniform("u_resolution",[e.width,e.height]),fancyShader.setUniform("u_time",o/1e3),fancyShader.setUniform("count",count),fancyShader.setUniform("seeds",seeds),fancyShader.setUniform("colors",colors),fancyShader.setUniform("positions",positions),fancyShader.setUniform("velocities",velocities),fancyShader.setUniform("explosions",explosions),fancyGraphics.shader(fancyShader),fancyGraphics.rect(0,0,e.width,e.height),e.image(fancyGraphics,0,0);return}e.clear();for(const t of rockets){if(!t.launched)continue;const s=(t.pos.x+.5)*e.width,n=e.height-(t.pos.y+.5)*e.height;e.noStroke(),e.fill(t.hue,1,.5),e.ellipse(s,n,8),t.explosion>0&&(e.stroke(t.hue,1,.5),e.noFill(),e.ellipse(s,n,radius*t.explosion))}},e.windowResized=()=>{e.resizeCanvas(e.windowWidth,e.windowHeight),fancyGraphics.resizeCanvas(e.width,e.height),setMeasurements(e)}}function setMeasurements(e){radius=Math.min(e.width,e.height)*.25}function serialize(){count=0,seeds=[],colors=[],positions=[],velocities=[],explosions=[];for(const e of rockets)!e.launched||(count+=1,seeds.push(e.seed),colors.push(...hue2rgb(e.hue)),positions.push(e.pos.x,e.pos.y),velocities.push(e.vel.x,e.vel.y),explosions.push(e.explosion))}function hue2rgb(e){e/=60;const o=t=>(t=t<0?t+6:t>=6?t-6:t,t<1?t:t<3?1:t<4?4-t:0);return[o(e+2),o(e),o(e-2)]}const socket=io(),elements={modal:document.getElementById("modal-content"),modalWrap:document.getElementById("modal-wrap"),modalButton:document.getElementById("modal-button"),countdownWrap:document.getElementById("countdown-wrap"),colorPreview:document.getElementById("color-preview")},form=document.forms["rocket-config"];document.querySelector("label[for=range-hue]").classList.add("disabled"),form.elements["range-hue"].setAttribute("disabled",""),form.elements["range-hue"].value=0,form.elements["check-custom-color"].checked=settings.useCustomColor,form.elements["check-fancy-graphics"].checked=settings.useFancyGraphics,form.elements["check-mute"].checked=settings$1.mutedAudio,elements.modalButton.addEventListener(clickEvent,toggleModal),form.elements["range-hue"].addEventListener("input",changeCustomColorHue),form.elements["check-custom-color"].addEventListener("change",toggleCustomColor),form.elements["check-fancy-graphics"].addEventListener("change",toggleFancyGraphics),form.elements["check-mute"].addEventListener("change",toggleAudio),socket.on("data",e=>launchRocket(e)),window.addEventListener("keyup",emitRocketLaunch),elements.countdownWrap.addEventListener(clickEvent,emitRocketLaunch);function toggleModal(){elements.modal.classList.toggle("visible")}function toggleCustomColor(e){settings.useCustomColor=e.target.checked,settings.useCustomColor?(document.querySelector("label[for=range-hue]").classList.remove("disabled"),elements.colorPreview.style.setProperty("background",`hsl(${settings.customColorHue}, 100%, 50%)`),form.elements["range-hue"].removeAttribute("disabled")):(document.querySelector("label[for=range-hue]").classList.add("disabled"),elements.colorPreview.style.removeProperty("background"),form.elements["range-hue"].setAttribute("disabled",""))}function changeCustomColorHue(e){settings.customColorHue=e.target.value,elements.colorPreview.style.setProperty("background",`hsl(${settings.customColorHue}, 100%, 50%)`)}function toggleFancyGraphics(e){settings.useFancyGraphics=e.target.checked}function toggleAudio(e){settings$1.mutedAudio=e.target.checked}function emitRocketLaunch(e){if(e.type==="keyup"&&e.keyCode!==32||!pInstReady||!audioReady)return;const o=getRocketValues();o&&socket.emit("launch",o)}
